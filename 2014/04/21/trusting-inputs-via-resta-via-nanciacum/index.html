<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:title" content="Trusting Inputs, Via RESTa Via Nanciacum"><meta property="og:description" content="All too often, security is treated as an afterthought in our models. I&rsquo;m as guilty of this as anyone. :) Now that HTTP is becoming the most popular protocol inside the enterprise, sending bad data across the wire becomes much easier. A hidden input field is not all that hidden.
Let&rsquo;s take everyone&rsquo;s second favorite fake business problem: Enrolling Students in Classes. Let&rsquo;s take it further and say we want to develop this as a SaaS product."><meta property="og:type" content="article"><meta property="og:url" content="https://the.fringe.ninja/2014/04/21/trusting-inputs-via-resta-via-nanciacum/"><meta property="article:published_time" content="2014-04-21T13:52:37-07:00"><meta property="article:modified_time" content="2014-04-21T13:52:37-07:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Trusting Inputs, Via RESTa Via Nanciacum"><meta name=twitter:description content="All too often, security is treated as an afterthought in our models. I&rsquo;m as guilty of this as anyone. :) Now that HTTP is becoming the most popular protocol inside the enterprise, sending bad data across the wire becomes much easier. A hidden input field is not all that hidden.
Let&rsquo;s take everyone&rsquo;s second favorite fake business problem: Enrolling Students in Classes. Let&rsquo;s take it further and say we want to develop this as a SaaS product."><meta name=description content><link rel=canonical href=https://the.fringe.ninja/2014/04/21/trusting-inputs-via-resta-via-nanciacum/><title>Trusting Inputs, Via RESTa Via Nanciacum &#183; Ninja Snacks</title><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css><link href=https://the.fringe.ninja/css/style.css rel=stylesheet></head><body><nav class=white role=navigation><div class="row max-width"><div class="col s12 l10 offset-l1"><a href=# data-target=nav-mobile class="sidenav-trigger black-text"><i class=material-icons>menu</i></a><ul id=nav-mobile class=sidenav><li><a class=black-text href=/><i class="material-icons left">home</i>Home</a></li><li><a class=black-text href=/resume><i class="material-icons left">assignment</i>Resume</a></li></ul><a href=/ class="brand-logo grey-text text-darken-3">Ninja Snacks <small>- Tales from the Enterprise</small></a><div class=nav-wrapper><ul class="right hide-on-med-and-down"><li><a class=black-text href=/><i class="material-icons left">home</i>Home</a></li><li><a class=black-text href=/resume><i class="material-icons left">assignment</i>Resume</a></li></ul></div></div></div></nav><article class=max-width><header class=row><div class="col s12 m10 offset-m1 l10 offset-l1"><h1>Trusting Inputs, Via RESTa Via Nanciacum</h1><address>João P. Bragança</address><time datetime=2014-04-21>Mon, 21 Apr 2014 13:52</time></div></header><section class=row><div class="col s12 m10 offset-m1 l10 offset-l1"><p>All too often, security is treated as an afterthought in our models. I&rsquo;m as guilty of this as anyone. :) Now that HTTP is becoming the most popular protocol inside the enterprise, sending bad data across the wire becomes much easier. A hidden input field is not all that hidden.</p><p>Let&rsquo;s take everyone&rsquo;s second favorite fake business problem: Enrolling Students in Classes. Let&rsquo;s take it further and say we want to develop this as a SaaS product. It&rsquo;ll need to be a multi tenant application. There are lots of independent community colleges (<code>Institutions</code>) out there and we don&rsquo;t want to run a VM or process per <code>Institution</code>.</p><p>Obviously, we will need to prevent cross contamination between tenants. Imagine the horror if a student changed the <code>institution-id</code> on his HTML form and we blindly let it through. </p><p>Sure, we could load the <code>Institution</code> from persistent storage and ensure the <code>Enrollee</code> is actually enrolled there and that the <code>Class</code> is offered. But you can imagine how large that collection would be. We can get better performance if we sign these requests.</p><p>Let&rsquo;s fix this problem by applying the principles of REST.</p><h2 id=restful-interactions>RESTful Interactions</h2><p>Often times when we talk about REST, we assume it has something to do with HTTP verbs and JSON. I hear it in job interviews all the time:</p><blockquote><p>Them: &ldquo;Can you explain REST?&rdquo;</p></blockquote><blockquote><p>Me: &ldquo;Sure! REST is REpresentational State Transfer. The client may only do (manipulate resources) what the server tells it to (via representations of those resources). Simply put, a RESTful client starts at the bookmark URL and&mldr;&rdquo;</p></blockquote><blockquote><p>Them: &ldquo;No, I mean explain what some HTTP verbs are and what they do.&rdquo;</p></blockquote><blockquote><p>Me: &ldquo;&mldr;&rdquo;</p></blockquote><p>Don&rsquo;t misunderstand me - JSON over HTTP is a huge improvement over SOAP and all the baggage that comes with. But, this is not how humans typically interact with resources - we don&rsquo;t load up Fiddler2 and start POSTing data to random URLs. We type in a root url, click links, submit forms and click more links.</p><p>Also, you can now see the problem of the client knowing too much here. We&rsquo;d have to distribute these secret keys to all clients. They&rsquo;d also have to know how to sign the request. If we want to change this logic, we either have to a) maintain separate URL hierarchies for each version b) maintain separate media types for each version or c) redeploy every phone app and break backwards compatibility. REST shines by skipping this problem entirely.</p><p>Instead, the server and the server alone should contain this logic.</p><p>``html
GET /my-awesome-party-school/classes?q=american%20history HTTP/1.1 
Authorize: [token]</p><p>HTTP/1.1 200 OK</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>GET /my-awesome-party-school/enroll?institution-id=1<span style=color:#960050;background-color:#1e0010>&amp;</span>class-id=2<span style=color:#960050;background-color:#1e0010>&amp;</span>student-id=3<span style=color:#960050;background-color:#1e0010>&amp;</span>title=American%20History%20X<span style=color:#960050;background-color:#1e0010>&amp;</span>**token=somehash**
Authorize: [token]

HTTP/1.1 200 OK

&lt;<span style=color:#f92672>html</span>&gt;
    &lt;<span style=color:#f92672>body</span>&gt;
        &lt;<span style=color:#f92672>form</span> <span style=color:#a6e22e>action</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/my-awesome-party-school/enroll&#34;</span> <span style=color:#a6e22e>method</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;POST&#34;</span>&gt;
            &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;hidden&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;institution-id&#34;</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;1&#34;</span> /&gt;
            &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;hidden&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;class-id&#34;</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;2&#34;</span> /&gt;
            &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;hidden&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;student-id&#34;</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;3&#34;</span> /&gt;
            **&lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;hidden&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;token&#34;</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;somehash&#34;</span> /&gt;**
            Reason for taking this class: &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;reason&#34;</span> /&gt; <span style=color:#75715e>&lt;!-- does not take part in hash --&gt;</span>
        &lt;/<span style=color:#f92672>form</span>&gt;
    &lt;/<span style=color:#f92672>body</span>&gt;
&lt;/<span style=color:#f92672>html</span>&gt;
</code></pre></div><p>And then of course we <code>POST</code> the form back. If anyone tries to tamper with the request, we&rsquo;ll know.</p><h2 id=the-nancy-bits>The Nancy Bits</h2><p>Behold, the power of NANCY! This is pretty trivial to do with a little help from our friend <a href=https://www.nuget.org/packages/Nancy.Validation.FluentValidation>Nancy.Validation.FluentValidation</a>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> Secured {
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> Token { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
}

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>delegate</span> <span style=color:#66d9ef>string</span> CalculateToken&lt;T&gt;(T input);

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CommandValidator</span>&lt;T&gt; : AbstractValidator&lt;T&gt; <span style=color:#66d9ef>where</span> T: Secured {
    <span style=color:#66d9ef>protected</span> CommandValidator(CalculateToken&lt;T&gt; calculateToken) {
        Func&lt;T, <span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>bool</span>&gt; match = (dto, token) =&gt; calculateToken(dto).Equals(token);
        
        RuleFor(x =&gt; x.Token).Must(match).WithMessage(<span style=color:#e6db74>&#34;Nice try hacker&#34;</span>);
    }
}

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EnrollValidator</span> : CommandValidator&lt;EnrollBuilder&gt; {
    <span style=color:#66d9ef>public</span> EnrollValidator() {
        RuleFor(x =&gt; x.Reason).Must(NotContainBadWords);
    }
    
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>bool</span> NotContainBadWords(<span style=color:#66d9ef>string</span> s) {
        <span style=color:#75715e>// use your imagination
</span><span style=color:#75715e></span>    }
}

<span style=color:#75715e>// module code
</span><span style=color:#75715e></span>Get[<span style=color:#e6db74>&#34;/{institution}/enroll&#34;</span>] = _ =&gt; {
    <span style=color:#66d9ef>var</span> builder = <span style=color:#66d9ef>this</span>.Bind&lt;EnrollBuilder&gt;();
    <span style=color:#66d9ef>return</span> Negotiate.WithModel(builder);
}
Post[<span style=color:#e6db74>&#34;/{institution}/enroll&#34;</span>] = _ =&gt; {
    Enroll command = <span style=color:#66d9ef>this</span>.BindAndValidate&lt;EnrollBuilder&gt;(); <span style=color:#75715e>// use two classes here to keep Token concept out of command
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>false</span> == ModelValidationResult.IsValid)
    {
        <span style=color:#66d9ef>return</span> Negotiate.WithModel(
            <span style=color:#66d9ef>new</span> ValidationErrorsViewModel(ModelValidationResult))
                        .WithStatusCode(<span style=color:#ae81ff>400</span>);
    }
    
    bus.Send(command);
}
<span style=color:#75715e>// Application Registrations
</span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Registrations</span> : IApplicationRegistrations
{
    <span style=color:#66d9ef>public</span> IEnumerable&lt;TypeRegistration&gt; TypeRegistrations { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>set</span>; }
    <span style=color:#66d9ef>public</span> IEnumerable&lt;CollectionTypeRegistration&gt; CollectionTypeRegistrations { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>set</span>; }

    <span style=color:#66d9ef>public</span> IEnumerable&lt;InstanceRegistration&gt; InstanceRegistrations
    {
        <span style=color:#66d9ef>get</span>
        {
               <span style=color:#75715e>// where Statically.CalculateHash takes a params object[] hashes with your super secret key from config, database, hard coded, whatever and returns a string
</span><span style=color:#75715e></span>            <span style=color:#66d9ef>yield</span> <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> InstanceRegistration(
                <span style=color:#66d9ef>typeof</span> (CalculateToken&lt;EnrollBuilder&gt;), <span style=color:#66d9ef>new</span> CalculateToken&lt;EnrollBuilder&gt;(dto =&gt; Statically.CalculateHash(dto.InstitutionId, dto.StudentId, dto.ClassId)));
                
        }
    }
}
</code></pre></div></div></section><footer class=row><div class="col s12 m10 offset-m1 l10 offset-l1"><p class=article-meta><a class=btn-small href=https://the.fringe.ninja/tags/nancyfx/>nancyfx</a>
<a class=btn-small href=https://the.fringe.ninja/tags/rest/>rest</a>
<a class=btn-small href=https://the.fringe.ninja/tags/hateoas/>hateoas</a></p></div></footer></article><footer class="page-footer grey lighten-5"><div class="row max-width"><div class="col s12 l10 offset-l1 clear-padding"><div class=row></div></div></div><div class=footer-copyright><div class="row max-width" style=width:100%><div class="col s12 l10 offset-l1"><span class="grey-text text-darken-4"></span><div class=right></div></div></div></div></footer><script src=https://code.jquery.com/jquery-3.2.1.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js></script><script src=https://the.fringe.ninja/js/script.js></script></body></html>