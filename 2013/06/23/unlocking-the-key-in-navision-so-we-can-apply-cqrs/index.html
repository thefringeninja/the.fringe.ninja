<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property=og:title content="Unlocking the Key in Navision So We Can Apply CQRS"><meta property=og:description content="The Soap Box Part We&rsquo;ve heard this before, but it bears repeating: CQRS is not just for greenfield event-sourced ddd systems. It can apply to crappy brownfield systems too. It may even have more relevance there.
Let&rsquo;s take the penultimate brownfield system, an ERP system. In particular, Navision. Navision has a fantastic interface for interacting with it (snipped for brevity):
public interface SalesPrice_Port { Read_Result Read(Read request); ReadMultiple_Result ReadMultiple(ReadMultiple request); Create_Result Create(Create request); Update_Result Update(Update request); Delete_Result Delete(Delete request); }  In other words, a 100% behavior free SQL-like interface that isn&rsquo;t sql because you have Create / Read instead of INSERT / SELECT."><meta property=og:type content=article><meta property=og:url content=https://the.fringe.ninja/2013/06/23/unlocking-the-key-in-navision-so-we-can-apply-cqrs/><meta property=article:published_time content=2013-06-23T14:46:11-07:00><meta property=article:modified_time content=2013-06-23T14:46:11-07:00><meta name=twitter:card content=summary><meta name=twitter:title content="Unlocking the Key in Navision So We Can Apply CQRS"><meta name=twitter:description content="The Soap Box Part We&rsquo;ve heard this before, but it bears repeating: CQRS is not just for greenfield event-sourced ddd systems. It can apply to crappy brownfield systems too. It may even have more relevance there.
Let&rsquo;s take the penultimate brownfield system, an ERP system. In particular, Navision. Navision has a fantastic interface for interacting with it (snipped for brevity):
public interface SalesPrice_Port { Read_Result Read(Read request); ReadMultiple_Result ReadMultiple(ReadMultiple request); Create_Result Create(Create request); Update_Result Update(Update request); Delete_Result Delete(Delete request); }  In other words, a 100% behavior free SQL-like interface that isn&rsquo;t sql because you have Create / Read instead of INSERT / SELECT."><meta name=description content><link rel=canonical href=https://the.fringe.ninja/2013/06/23/unlocking-the-key-in-navision-so-we-can-apply-cqrs/><title>Unlocking the Key in Navision So We Can Apply CQRS &middot; Ninja Snacks</title><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css><link href=https://the.fringe.ninja/css/style.css rel=stylesheet></head><body><nav class=white role=navigation><div class="row max-width"><div class="col s12 l10 offset-l1"><a href=# data-target=nav-mobile class="sidenav-trigger black-text"><i class=material-icons>menu</i></a><ul id=nav-mobile class=sidenav><li><a class=black-text href=/><i class="material-icons left">home</i>Home</a></li><li><a class=black-text href=/resume><i class="material-icons left">assignment</i>Resume</a></li></ul><a href=/ class="brand-logo grey-text text-darken-3">Ninja Snacks <small>- Tales from the Enterprise</small></a><div class=nav-wrapper><ul class="right hide-on-med-and-down"><li><a class=black-text href=/><i class="material-icons left">home</i>Home</a></li><li><a class=black-text href=/resume><i class="material-icons left">assignment</i>Resume</a></li></ul></div></div></div></nav><article class=max-width><header class=row><div class="col s12 m10 offset-m1 l10 offset-l1"><h1>Unlocking the Key in Navision So We Can Apply CQRS</h1><address>João P. Bragança</address><time datetime=2013-06-23>Sun, 23 Jun 2013 14:46</time></div></header><section class=row><div class="col s12 m10 offset-m1 l10 offset-l1"><h2 id=the-soap-box-part>The Soap Box Part</h2><p>We&rsquo;ve heard this before, but it bears repeating: CQRS is not just for greenfield event-sourced ddd systems. It can apply to crappy brownfield systems too. It may even have <em>more</em> relevance there.</p><p>Let&rsquo;s take the penultimate brownfield system, an ERP system. In particular, Navision. Navision has a <em>fantastic</em> interface for interacting with it (snipped for brevity):</p><pre><code class=language-csharp>public interface SalesPrice_Port
{
	Read_Result Read(Read request);
	ReadMultiple_Result ReadMultiple(ReadMultiple request);
	Create_Result Create(Create request);
	Update_Result Update(Update request);
	Delete_Result Delete(Delete request);
}
</code></pre><p>In other words, a 100% behavior free SQL-like interface that isn&rsquo;t sql because you have <code>Create</code> / <code>Read</code> instead of <code>INSERT</code> / <code>SELECT</code>. Yup. In addition to the obvious computing cost of serialization/deserialization, http, etc, there&rsquo;s a hidden mental cost as well:</p><pre><code class=language-csharp>var result = salesPricePort.ReadMultiple(new ReadMultiple
{
	filter = new[]
	{
		new SalesPrice_Filter
		{
			Field = SalesPrice_Fields.Sales_Type, Criteria = &quot;Customer&quot;
		},
		new SalesPrice_Filter
		{
			Field = SalesPrice_Fields.Sales_Code, Criteria = customerNumber
		},
		new SalesPrice_Filter
		{
			Field = SalesPrice_Fields.Item_No, Criteria = itemNumber
		},
		new SalesPrice_Filter
		{
			Field = SalesPrice_Fields.Variant_Code, Criteria = variant
		},
		new SalesPrice_Filter
		{
			Field = SalesPrice_Fields.Ending_Date, Criteria = null
		},
		new SalesPrice_Filter
		{
			Field = SalesPrice_Fields.Unit_of_Measure_Code, Criteria = Constants.UnitsOfMeasure.Pieces
		}
	}
});
</code></pre><p>Here&rsquo;s where CQRS fits into this. While suboptimal, the web service interface is good enough for creating / changing records. Most of the time we will either be a) hiding navision behind a much better UI that only exposes the fields that matter to the business or b) changing records based on an event coming in from another system, e.g. <code>PricingAttemptAccepted</code>.</p><p>The webservice interface is <em>terrible</em> for reading records. Good luck if you want to aggregate information. SQL is a much better fit for querying here. It also looks nicer too. Here&rsquo;s the same query in Simple.Data:</p><pre><code class=language-csharp>var navision = NavisionDatabase.OpenNamedConnection(&quot;navision&quot;);

var prices = navision.SalesPrices;

var result = prices.All.Where(prices.SalesType == &quot;Customer&quot; 
	&amp;&amp; prices.SalesCode == customerNumber 
	&amp;&amp; prices.ItemNumber == itemNumber 
	&amp;&amp; prices.VariantCode == variant
	&amp;&amp; prices.EndingDate == null
	&amp;&amp; prices.UnitOfMeasureCode == Constants.UnitsOfMeasure.Pieces);
</code></pre><p>This works just fine most of the time. Until you need to read before updating. Navision web services have this concept of a <code>Key</code> - you send the <code>Key</code> you get with a Read request with any subsequent Update or Delete requests, presumably as a form of concurreny control. Which is dumb because you already <em>have</em>  most of the <code>Key</code> information. All you need is the timestamp.</p><h2 id=the-fixing-it-part>The Fixing it Part</h2><p>From what I can tell so far, the <code>Key</code> is based on what would be the primary key in the table, the timestamp, and some voodoo. Let&rsquo;s take a relatively simple record type, <code>Item</code>. <code>Item</code> has only it&rsquo;s number as the PK, a <code>code[20]</code>. Other record types, such as <code>SalePrice</code>, have far more columns.</p><pre><code class=language-json>{
	&quot;No_&quot;: &quot;ATAT1001&quot;,
	&quot;timestamp&quot;: &quot;0x000000002F5736A6&quot;
}
</code></pre><p>Invoking the Navision web service gives the <code>Key</code> as <code>20;GwAAAACJ/0FUQVQxMDAx9;7942447740;</code>. It seems to be</p><pre><code>{Length of Base 64 Part};{Base 64 Encoded Stuff}9;{Timestamp}0;
</code></pre><p>AFAICT the 9; and 0; are just formatting garbage. Now, let&rsquo;s decode the string:</p><pre><code>{
	Decoded: [ &quot;1b&quot;, &quot;0&quot;, &quot;0&quot;, &quot;0&quot;, &quot;0&quot;, &quot;89&quot;, &quot;ff&quot;, &quot;41&quot;, &quot;54&quot;, &quot;41&quot;, &quot;54&quot;, &quot;31&quot;, &quot;30&quot;, &quot;30&quot;, &quot;31&quot; ]
}
</code></pre><p>Ok, now I&rsquo;m making progress! <code>1b</code> is <code>27</code> in decimal. I know that the <code>Item</code> table is program 27. So the first 5 bytes seem to be the table number, little-endian. Also, <code>41-54-41-54-31-30-30-31</code> is just <code>ATAT1001</code>. Awesome! That just leaves <code>89-ff</code>, I can&rsquo;t figure that out yet. I&rsquo;ll leave that for another post.</p></div></section><footer class=row><div class="col s12 m10 offset-m1 l10 offset-l1"><p class=article-meta><a class=btn-small href=https://the.fringe.ninja/tags/cqrs/>cqrs</a>
<a class=btn-small href=https://the.fringe.ninja/tags/navision/>navision</a></p></div></footer></article><footer class="page-footer grey lighten-5"><div class="row max-width"><div class="col s12 l10 offset-l1 clear-padding"><div class=row></div></div></div><div class=footer-copyright><div class="row max-width" style=width:100%><div class="col s12 l10 offset-l1"><span class="grey-text text-darken-4"></span><div class=right></div></div></div></div></footer><script src=https://code.jquery.com/jquery-3.2.1.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js></script><script src=https://the.fringe.ninja/js/script.js></script></body></html>