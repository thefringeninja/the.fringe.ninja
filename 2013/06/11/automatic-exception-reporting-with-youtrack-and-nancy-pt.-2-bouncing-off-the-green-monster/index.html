<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:title" content="Automatic Exception Reporting with YouTrack and Nancy pt. 2: Bouncing Off the Green Monster"><meta property="og:description" content="In Part 1 of this series we looked at putting NancyFX as a simple http wrapper in front of YouTrack. Now we&rsquo;re going to make it more RESTful - i.e. we will display the error page to the user agent and include the exception report form on that page.
We will do this by leveraging Nancy&rsquo;s status code handling features. This will allow us to intercept any status code we want and modify the response."><meta property="og:type" content="article"><meta property="og:url" content="https://the.fringe.ninja/2013/06/11/automatic-exception-reporting-with-youtrack-and-nancy-pt.-2-bouncing-off-the-green-monster/"><meta property="article:published_time" content="2013-06-11T10:00:00-07:00"><meta property="article:modified_time" content="2013-06-11T10:00:00-07:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Automatic Exception Reporting with YouTrack and Nancy pt. 2: Bouncing Off the Green Monster"><meta name=twitter:description content="In Part 1 of this series we looked at putting NancyFX as a simple http wrapper in front of YouTrack. Now we&rsquo;re going to make it more RESTful - i.e. we will display the error page to the user agent and include the exception report form on that page.
We will do this by leveraging Nancy&rsquo;s status code handling features. This will allow us to intercept any status code we want and modify the response."><meta name=description content><link rel=canonical href=https://the.fringe.ninja/2013/06/11/automatic-exception-reporting-with-youtrack-and-nancy-pt.-2-bouncing-off-the-green-monster/><title>Automatic Exception Reporting with YouTrack and Nancy pt. 2: Bouncing Off the Green Monster &#183; Ninja Snacks</title><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css><link href=https://the.fringe.ninja/css/style.css rel=stylesheet></head><body><nav class=white role=navigation><div class="row max-width"><div class="col s12 l10 offset-l1"><a href=# data-target=nav-mobile class="sidenav-trigger black-text"><i class=material-icons>menu</i></a><ul id=nav-mobile class=sidenav><li><a class=black-text href=/><i class="material-icons left">home</i>Home</a></li><li><a class=black-text href=/resume><i class="material-icons left">assignment</i>Resume</a></li></ul><a href=/ class="brand-logo grey-text text-darken-3">Ninja Snacks <small>- Tales from the Enterprise</small></a><div class=nav-wrapper><ul class="right hide-on-med-and-down"><li><a class=black-text href=/><i class="material-icons left">home</i>Home</a></li><li><a class=black-text href=/resume><i class="material-icons left">assignment</i>Resume</a></li></ul></div></div></div></nav><article class=max-width><header class=row><div class="col s12 m10 offset-m1 l10 offset-l1"><h1>Automatic Exception Reporting with YouTrack and Nancy pt. 2: Bouncing Off the Green Monster</h1><address>João P. Bragança</address><time datetime=2013-06-11>Tue, 11 Jun 2013 10:00</time></div></header><section class=row><div class="col s12 m10 offset-m1 l10 offset-l1"><p>In <a href=/193/automatic-exception-reporting-with-you-track-and-nancy-pt-1-the-skeleton>Part 1</a> of this series we looked at putting <a href=http://nancyfx.org>NancyFX</a> as a simple http wrapper in front of <a href=http://jetbrains.com/youtrack>YouTrack</a>. Now we&rsquo;re going to make it more RESTful - i.e. we will display the error page to the user agent and <em>include the exception report form</em> on that page.</p><p>We will do this by leveraging Nancy&rsquo;s status code handling features. This will allow us to intercept any status code we want and modify the response. Let&rsquo;s start with the view to collect the bug report:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>@inherits NancyRazorViewBase&lt;<span style=color:#f92672>Nancy.Extras.ExceptionReporting.ViewModels.ReportExceptionViewModel</span>&gt;
<span style=color:#75715e>&lt;!DOCTYPE html&gt;</span>
&lt;<span style=color:#f92672>html</span>&gt;
<span style=color:#75715e>&lt;!-- Views/50x.cshtml --&gt;</span>
&lt;<span style=color:#f92672>head</span>&gt;
    &lt;<span style=color:#f92672>title</span>&gt;@((int)RenderContext.Context.Response.StatusCode) @RenderContext.Context.Response.StatusCode&lt;/<span style=color:#f92672>title</span>&gt;
&lt;/<span style=color:#f92672>head</span>&gt;
&lt;<span style=color:#f92672>body</span>&gt;
    &lt;<span style=color:#f92672>h1</span>&gt;@((int)RenderContext.Context.Response.StatusCode) @RenderContext.Context.Response.StatusCode&lt;/<span style=color:#f92672>h1</span>&gt;
    &lt;<span style=color:#f92672>p</span>&gt;A server error occurred.&lt;/<span style=color:#f92672>p</span>&gt;
    &lt;<span style=color:#f92672>section</span>&gt;
        &lt;<span style=color:#f92672>h2</span>&gt;Submit Bug Report&lt;/<span style=color:#f92672>h2</span>&gt;
        &lt;<span style=color:#f92672>p</span>&gt;You may submit a bug report. While you don&#39;t have to, it would be super helpful if you did.&lt;/<span style=color:#f92672>p</span>&gt;
        &lt;<span style=color:#f92672>form</span> <span style=color:#a6e22e>action</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;~/issues/report-exception&#34;</span> <span style=color:#a6e22e>method</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;POST&#34;</span>&gt;
            &lt;<span style=color:#f92672>label</span>&gt;Notes:&lt;/<span style=color:#f92672>label</span>&gt;
            &lt;<span style=color:#f92672>textarea</span> <span style=color:#a6e22e>title</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Please include as much detail as you can.&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Notes&#34;</span>&gt;&lt;/<span style=color:#f92672>textarea</span>&gt;
            &lt;<span style=color:#f92672>details</span>&gt;
                &lt;<span style=color:#f92672>summary</span>&gt;Additional information will be submitted with your request:&lt;/<span style=color:#f92672>summary</span>&gt;
                &lt;<span style=color:#f92672>ul</span>&gt;
                    &lt;<span style=color:#f92672>li</span>&gt;Exception Type:
                        &lt;<span style=color:#f92672>pre</span>&gt;@Model.ExceptionType&lt;/<span style=color:#f92672>pre</span>&gt;
                    &lt;/<span style=color:#f92672>li</span>&gt;
                    &lt;<span style=color:#f92672>li</span>&gt;Exception Detail:
                        &lt;<span style=color:#f92672>pre</span>&gt;@Model.ExceptionDetail&lt;/<span style=color:#f92672>pre</span>&gt;
                    &lt;/<span style=color:#f92672>li</span>&gt;
                    &lt;<span style=color:#f92672>li</span>&gt;User Id:
                        &lt;<span style=color:#f92672>pre</span>&gt;@Model.UserId&lt;/<span style=color:#f92672>pre</span>&gt;
                    &lt;/<span style=color:#f92672>li</span>&gt;
                    &lt;<span style=color:#f92672>li</span>&gt;Location:
                        &lt;<span style=color:#f92672>pre</span>&gt;@Model.Location&lt;/<span style=color:#f92672>pre</span>&gt;
                    &lt;/<span style=color:#f92672>li</span>&gt;
                    &lt;<span style=color:#f92672>li</span>&gt;Request Entity:
                        &lt;<span style=color:#f92672>pre</span>&gt;@Model.RequestEntity&lt;/<span style=color:#f92672>pre</span>&gt;
                    &lt;/<span style=color:#f92672>li</span>&gt;
                &lt;/<span style=color:#f92672>ul</span>&gt;
            &lt;/<span style=color:#f92672>details</span>&gt;

            &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;hidden&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ExceptionType&#34;</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;@Model.ExceptionType&#34;</span> /&gt;
            &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;hidden&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ExceptionDetail&#34;</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;@Model.ExceptionDetail&#34;</span> /&gt;
            &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;hidden&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;UserId&#34;</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;@Model.UserId&#34;</span> /&gt;
            &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;hidden&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Location&#34;</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;@Model.Location&#34;</span> /&gt;
            &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;hidden&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;RequestEntity&#34;</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;@Model.RequestEntity&#34;</span> /&gt;
            &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;hidden&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ProjectId&#34;</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;AWE&#34;</span> /&gt;
            &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;submit&#34;</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Submit Bug Report&#34;</span>/&gt;
        &lt;/<span style=color:#f92672>form</span>&gt;
    &lt;/<span style=color:#f92672>section</span>&gt;
&lt;/<span style=color:#f92672>body</span>&gt;
&lt;/<span style=color:#f92672>html</span>&gt;
</code></pre></div><p>Make sure you have your web.config set up properly for Razor. Basically you need to specify both <code>Nancy.ViewEngines.Razor.RazorConfigurationSection, Nancy.ViewEngines.Razor</code> and <code>System.Web.WebPages.Razor.Configuration.RazorPagesSection, System.Web.WebPages.Razor, Version=2.0.0.0, Culture=neutral, PublicKeyToken=31BF3856AD364E35</code>. Otherwise Nancy&rsquo;s razor engine will blow up as it does not reference the System assembly directly.</p><p>Then we need an <code>IStatusCodeHandler</code> implementation:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>YouTrackStatusCodeHandler</span> : IStatusCodeHandler
{
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> IViewFactory viewFactory;

    <span style=color:#66d9ef>public</span> YouTrackStatusCodeHandler(IViewFactory viewFactory)
    {
        <span style=color:#66d9ef>this</span>.viewFactory = viewFactory;
    }

    <span style=color:#75715e>#region IStatusCodeHandler Members
</span><span style=color:#75715e></span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>bool</span> HandlesStatusCode(HttpStatusCode statusCode, NancyContext context)
    {
        <span style=color:#66d9ef>return</span> (<span style=color:#66d9ef>int</span>) statusCode &gt;= <span style=color:#ae81ff>500</span>;
    }

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> Handle(HttpStatusCode statusCode, NancyContext context)
    {
        <span style=color:#66d9ef>var</span> viewModel = GetViewModel(context);

        <span style=color:#66d9ef>var</span> originalStatusCode = context.Response.StatusCode;

        context.Response = viewFactory.RenderView(<span style=color:#e6db74>&#34;50x&#34;</span>, viewModel, <span style=color:#66d9ef>new</span> ViewLocationContext
        {
            Context = context
        }).WithStatusCode(originalStatusCode);
    }

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>string</span> GetRequestEntity(Request request)
    {
        <span style=color:#66d9ef>var</span> requestEntityBuilder = <span style=color:#66d9ef>new</span> StringBuilder()
            .Append(request.Method).Append(<span style=color:#e6db74>&#39; &#39;</span>).Append(request.Url).AppendLine();
        
        <span style=color:#66d9ef>var</span> headers = <span style=color:#66d9ef>from</span> header <span style=color:#66d9ef>in</span> request.Headers
                         <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>value</span> = String.Join(<span style=color:#e6db74>&#34;, &#34;</span>, header.Value)
                         <span style=color:#66d9ef>select</span> <span style=color:#66d9ef>new</span> {key = header.Key, <span style=color:#66d9ef>value</span>};
        
        headers.Aggregate(requestEntityBuilder,
                             (builder, header) =&gt; builder.Append(header.key).Append(<span style=color:#e6db74>&#34;: &#34;</span>)
                                                         .Append(header.<span style=color:#66d9ef>value</span>)
                                                         .AppendLine());

        <span style=color:#66d9ef>return</span> requestEntityBuilder.ToString();
    }

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> ReportExceptionViewModel GetViewModel(NancyContext context)
    {
        <span style=color:#66d9ef>var</span> viewModel = <span style=color:#66d9ef>new</span> ReportExceptionViewModel
        {
            Location = context.Request.Url,
            RequestEntity = GetRequestEntity(context.Request),
            UserId = context.CurrentUser == <span style=color:#66d9ef>null</span> ? <span style=color:#e6db74>&#34;(anonymous)&#34;</span> : context.CurrentUser.UserName
        };

        <span style=color:#66d9ef>var</span> exception = context.Items[NancyEngine.ERROR_EXCEPTION] <span style=color:#66d9ef>as</span> Exception;

        <span style=color:#66d9ef>if</span> (exception == <span style=color:#66d9ef>null</span>) <span style=color:#75715e>// means we just returned a server error out of our module
</span><span style=color:#75715e></span>        {
            viewModel.ExceptionType = context.Response.StatusCode.ToString();
            <span style=color:#66d9ef>return</span> viewModel;
        }

        <span style=color:#66d9ef>if</span> (exception <span style=color:#66d9ef>is</span> RequestExecutionException &amp;&amp; exception.InnerException != <span style=color:#66d9ef>null</span>)
        {
            exception = exception.InnerException;
        }

        viewModel.ExceptionDetail = exception.ToString();
        viewModel.ExceptionType = exception.GetType().FullName;

        <span style=color:#66d9ef>return</span> viewModel;
    }

    <span style=color:#75715e>#endregion
</span><span style=color:#75715e></span>}
</code></pre></div><p>We&rsquo;re only going to respond to <a href=https://twitter.com/DanaDanger/status/183316183494311936>5xx status codes</a>. You should return a 4xx code if you think the client messed up the request, e.g. <a href=http://tools.ietf.org/html/draft-ietf-httpbis-p2-semantics-22#section-6.5.4>bookmarking a link they shouldn&rsquo;t have</a>.</p><p>You&rsquo;ll also notice we aren&rsquo;t doing any content negotiation here. Wiring this to an <code>application/json</code> based api is outside the scope of this blog post. If you want to see how this could be done, <a href=http://paulstovell.com/>Paul Stovell</a> has a good blog post <a href=http://paulstovell.com/blog/consistent-error-handling-with-nancy>showing how to do content negotiation inside a IStatusCodeHandler</a>.</p><p>The last thing we need to do is patch our <code>IssuesModule</code> to do more than return a status code:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp>-			issues.CreateIssue(issue);
+			<span style=color:#66d9ef>var</span> issueId = issues.CreateIssue(issue);

-			<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>200</span>;
+			<span style=color:#66d9ef>return</span> Negotiate.WithModel(<span style=color:#66d9ef>new</span> ExceptionReportedViewModel(issueId, Context));
</code></pre></div><p>This way we can leverage Nancy&rsquo;s excellent view selection feature.</p><p>If you&rsquo;re like me (and lucky enough to use Nancy), you probably have multiple Nancy based apps scattered all over the enterprise. And as much as I am a fan of copy and paste, I certainly wouldn&rsquo;t want to copypasta this all over the place. For the final post in this series, I&rsquo;m going to show how you can make this composable.</p></div></section><footer class=row><div class="col s12 m10 offset-m1 l10 offset-l1"><p class=article-meta><a class=btn-small href=https://the.fringe.ninja/tags/nancyfx/>nancyfx</a>
<a class=btn-small href=https://the.fringe.ninja/tags/youtrack/>youtrack</a></p></div></footer></article><footer class="page-footer grey lighten-5"><div class="row max-width"><div class="col s12 l10 offset-l1 clear-padding"><div class=row></div></div></div><div class=footer-copyright><div class="row max-width" style=width:100%><div class="col s12 l10 offset-l1"><span class="grey-text text-darken-4"></span><div class=right></div></div></div></div></footer><script src=https://code.jquery.com/jquery-3.2.1.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js></script><script src=https://the.fringe.ninja/js/script.js></script></body></html>